FROM node:22-bookworm-slim@sha256:REPLACE_WITH_ACTUAL_DIGEST AS builder

WORKDIR /build

COPY package.json package-lock.json* ./

RUN --mount=type=cache,target=/root/.npm \
    npm ci --prefer-offline --no-audit

COPY . .

RUN npm run build

FROM node:22-bookworm-slim@sha256:REPLACE_WITH_ACTUAL_DIGEST AS runtime

RUN groupadd -r appgroup -g 1000 && \
    useradd -r -g appgroup -u 1000 appuser

WORKDIR /app

COPY --from=builder --chown=appuser:appgroup /build/package.json ./
COPY --from=builder --chown=appuser:appgroup /build/node_modules ./node_modules
COPY --from=builder --chown=appuser:appgroup /build/dist ./dist

USER appuser

EXPOSE 3000

CMD ["node", "dist/index.js"]
